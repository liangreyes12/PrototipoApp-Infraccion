<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="icon" href="../img/history.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: #ebfaff7e;
    }
    
    .dashboard {
      max-width: 95%;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: rgb(30, 71, 124);
      font-weight: bold;
    }
    table {
      font-size: 0.95rem;
    }
    .btn-primary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body>

<div class="dashboard">
  <h2 class="text-center mb-4"><i class="bi bi-clipboard-data"></i> Historial de Infracciones</h2>

  <!-- Filtros -->
  <div class="row mb-4 g-3">
    <div class="col-md-4">
      <input type="text" id="filtroDocumento" class="form-control" placeholder="Buscar por documento">
    </div>
    <div class="col-md-4">
      <input type="text" id="filtroInfraccion" class="form-control" placeholder="Buscar por infracción">
    </div>
    <div class="col-md-4">
      <input type="month" id="filtroMes" class="form-control">
    </div>
  </div>

  <div class="d-flex justify-content-end mb-2">
    <button class="btn btn-primary" onclick="descargarCSV()">
      <i class="bi bi-download"></i> Descargar CSV
    </button>
  </div>

  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" id="tablaHistorial">
      <thead class="table-primary">
        <tr>
          <th>Nombre</th>
          <th>Documento</th>
          <th>Correo</th>
          <th>Teléfono</th>
          <th>Infracción</th>
          <th>Observaciones</th>
          <th>Latitud</th>
          <th>Longitud</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="contenidoTabla">
        <!-- Aquí se insertan las filas dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<script>
  const registros = [
    {
      nombre: "Juan Pérez",
      documento: "123456789",
      correo: "juan@email.com",
      telefono: "3216549870",
      infraccion: "Exceso de velocidad",
      observaciones: "Conductor en moto.",
      latitud: "4.60971",
      longitud: "-74.08175",
      fecha: "2025-05-17T10:32"
    },
    {
      nombre: "Ana Torres",
      documento: "987654321",
      correo: "ana@email.com",
      telefono: "3102568741",
      infraccion: "Mal estacionado",
      observaciones: "Zona peatonal.",
      latitud: "4.65145",
      longitud: "-74.10622",
      fecha: "2025-04-09T08:22"
    }
  ];

  const cuerpoTabla = document.getElementById("contenidoTabla");

  function cargarTabla(filtrados) {
    cuerpoTabla.innerHTML = "";
    filtrados.forEach(reg => {
      const fila = document.createElement("tr");
      for (const key of ["nombre", "documento", "correo", "telefono", "infraccion", "observaciones", "latitud", "longitud", "fecha"]) {
        const celda = document.createElement("td");
        celda.textContent = reg[key];
        fila.appendChild(celda);
      }
      cuerpoTabla.appendChild(fila);
    });
  }

  // Carga inicial
  cargarTabla(registros);

  // Filtros en vivo
  document.getElementById("filtroDocumento").addEventListener("input", filtrar);
  document.getElementById("filtroInfraccion").addEventListener("input", filtrar);
  document.getElementById("filtroMes").addEventListener("input", filtrar);

  function filtrar() {
    const doc = document.getElementById("filtroDocumento").value.toLowerCase();
    const infr = document.getElementById("filtroInfraccion").value.toLowerCase();
    const mes = document.getElementById("filtroMes").value; // formato yyyy-mm

    const resultado = registros.filter(r => {
      return (
        r.documento.toLowerCase().includes(doc) &&
        r.infraccion.toLowerCase().includes(infr) &&
        (!mes || r.fecha.startsWith(mes))
      );
    });

    cargarTabla(resultado);
  }

  function descargarCSV() {
    const filas = Array.from(cuerpoTabla.querySelectorAll("tr"));
    if (filas.length === 0) {
      Swal.fire("No hay datos para descargar", "", "warning");
      return;
    }

    let csv = "Nombre,Documento,Correo,Teléfono,Infracción,Observaciones,Latitud,Longitud,Fecha\n";
    filas.forEach(fila => {
      const columnas = fila.querySelectorAll("td");
      const filaCSV = Array.from(columnas).map(celda => `"${celda.textContent}"`).join(",");
      csv += filaCSV + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const enlace = document.createElement("a");
    enlace.href = url;
    enlace.download = "historial_infracciones.csv";
    enlace.click();

    Swal.fire("Descarga completada", "El historial se ha descargado como CSV", "success");
  }
</script>

</body>
</html>
